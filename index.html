<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facilities Operation & Maintenance Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="data-manager.js"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">FOMD <span>Portal</span></div>
            <div class="header-info">
                <div id="current-datetime" class="datetime"></div>
            </div>
            <div class="admin-icon" id="admin-icon">
                <i class="fas fa-cog"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Login Section -->
        <section id="login-section" class="login-container">
            <div class="login-box">
                <div class="login-title">
                    <h2>FOMD Portal Login</h2>
                    <p>Enter your credentials to access the portal</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
                <div id="login-error" class="alert alert-error" style="display: none;">
                    Invalid username or password. Please try again.
                </div>
            </div>
        </section>

        <!-- User Dashboard -->
        <section id="user-dashboard" class="dashboard" style="display: none;">
            <div class="dashboard-header">
                <div>
                    <h2 id="user-dashboard-title">User Dashboard</h2>
                    <p class="welcome-message">Welcome, <span id="user-name">User</span>!</p>
                    <p class="user-level">Access Level: <span id="user-level-display">Guest</span></p>
                </div>
                <div class="nav-links">
                    <button id="access-admin-btn" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-cog"></i> Admin Dashboard
                    </button>
                    <a href="#" id="logout-link-user" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
            
            <div class="dashboard-section">
                <h3 class="section-title">Personnel Directory</h3>
                <div class="table-container">
                    <table id="personnel-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ID Number</th>
                                <th>Date Hired</th>
                                <th>Employment Status</th>
                                <th>Current Position</th>
                                <th>Work Status</th>
                                <th>Section Assignment</th>
                            </tr>
                        </thead>
                        <tbody id="personnel-table-body">
                            <!-- Personnel data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="dashboard" style="display: none;">
            <div class="dashboard-header">
                <div>
                    <h2>Administrator Dashboard</h2>
                    <p class="welcome-message">Welcome, Administrator!</p>
                </div>
                <div class="nav-links">
    <div class="user-pages-links">
        <a href="manager-page.html" class="btn btn-secondary user-page-link" target="_blank">
            <i class="fas fa-user-tie"></i> Manager Page
        </a>
        <a href="assistant-manager-page.html" class="btn btn-secondary user-page-link" target="_blank">
            <i class="fas fa-user-check"></i> Asst. Manager
        </a>
        <a href="office-secretary-page.html" class="btn btn-secondary user-page-link" target="_blank">
            <i class="fas fa-user-friends"></i> Office Secretary
        </a>
        <a href="section-supervisor-page.html" class="btn btn-secondary user-page-link" target="_blank">
            <i class="fas fa-user-cog"></i> Supervisor
        </a>
        <a href="guest-page.html" class="btn btn-secondary user-page-link" target="_blank">
            <i class="fas fa-user"></i> Guest Page
        </a>
    </div>
    
    <!-- ADD THESE NEW BUTTONS HERE -->
    <div class="admin-actions" style="margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="exportData()">
            <i class="fas fa-download"></i> Export Data
        </button>
        <button class="btn btn-secondary" onclick="importData()">
            <i class="fas fa-upload"></i> Import Data
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
            <i class="fas fa-trash"></i> Clear All Data
        </button>
    </div>
    
    <a href="#" id="back-to-user-btn" class="btn btn-secondary" style="display: none;">
        <i class="fas fa-arrow-left"></i> Back to User
    </a>
    <a href="#" id="logout-link-admin" class="btn btn-secondary">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>
            </div>

            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="tab-button active" data-tab="personnel-management">Personnel Management</button>
                <button class="tab-button" data-tab="user-management">User Management</button>
            </div>
            
            <!-- Personnel Management Tab -->
            <div id="personnel-management" class="tab-content active">
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">Personnel Management</h3>
                        <button class="btn btn-primary" id="add-personnel-btn">
                            <i class="fas fa-plus"></i> Add Personnel
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="admin-personnel-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>ID Number</th>
                                    <th>Date Hired</th>
                                    <th>Employment Status</th>
                                    <th>Current Position</th>
                                    <th>Work Status</th>
                                    <th>Section Assignment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-personnel-table-body">
                                <!-- Personnel data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="user-management" class="tab-content">
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">User Account Management</h3>
                        <button class="btn btn-primary" id="create-user-btn">
                            <i class="fas fa-user-plus"></i> Create New User
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="user-management-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Password</th>
                                    <th>User Level</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-management-table-body">
                                <!-- User management data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Administrator Access</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="admin-login-form">
                <div class="form-group">
                    <label for="admin-username">Admin Username</label>
                    <input type="text" id="admin-username" name="admin-username" required>
                </div>
                <div class="form-group">
                    <label for="admin-password">Admin Password</label>
                    <input type="password" id="admin-password" name="admin-password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
            <div id="admin-login-error" class="alert alert-error" style="display: none;">
                Invalid administrator credentials. Please try again.
            </div>
        </div>
    </div>

    <!-- Add/Edit Personnel Modal -->
    <div id="personnel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="personnel-modal-title">Add Personnel</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="personnel-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="family-name">Family Name</label>
                    <input type="text" id="family-name" name="family-name" required>
                </div>
                <div class="form-group">
                    <label for="first-name">First Name</label>
                    <input type="text" id="first-name" name="first-name" required>
                </div>
                <div class="form-group">
                    <label for="middle-name">Middle Name</label>
                    <input type="text" id="middle-name" name="middle-name">
                </div>
                <div class="form-group">
                    <label for="id-number">ID Number</label>
                    <input type="text" id="id-number" name="id-number" required>
                </div>
                <div class="form-group">
                    <label for="date-hired">Date Hired</label>
                    <input type="date" id="date-hired" name="date-hired" required>
                </div>
                <div class="form-group">
                    <label for="employment-status">Employment Status</label>
                    <select id="employment-status" name="employment-status" required>
                        <option value="">Select Status</option>
                        <option value="Regular">Regular</option>
                        <option value="Probationary">Probationary</option>
                        <option value="Temporary">Temporary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="current-position">Current Position</label>
                    <select id="current-position" name="current-position" required>
                        <option value="">Select Position</option>
                        <option value="Department Head">Department Head</option>
                        <option value="Assistant Department Head">Assistant Department Head</option>
                        <option value="Department Secretary">Department Secretary</option>
                        <option value="Section Supervisor">Section Supervisor</option>
                        <option value="Assistant Section Supervisor">Assistant Section Supervisor</option>
                        <option value="Chemical Engineer">Chemical Engineer</option>
                        <option value="Process Operator">Process Operator</option>
                        <option value="Maintenance Technician">Maintenance Technician</option>
                        <option value="Aide">Aide</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="work-status">Work Status</label>
                    <select id="work-status" name="work-status" required>
                        <option value="">Select Status</option>
                        <option value="Active">Active</option>
                        <option value="Resigned">Resigned</option>
                        <option value="Terminated">Terminated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="section-assignment">Section Assignment</label>
                    <select id="section-assignment" name="section-assignment" required>
                        <option value="">Select Section</option>
                        <option value="PF1 Line Maintenance">PF1 Line Maintenance</option>
                        <option value="PF1 Utilities Operation & Maint.">PF1 Utilities Operation & Maint.</option>
                        <option value="PF2 Line Maintenance">PF2 Line Maintenance</option>
                        <option value="PF1 HSRO Facility">PF1 HSRO Facility</option>
                        <option value="PF2 Utilities Operation & Maint.">PF2 Utilities Operation & Maint.</option>
                        <option value="PF3 Line Maintenance">PF3 Line Maintenance</option>
                        <option value="PF3 Utilities Operation & Maint.">PF3 Utilities Operation & Maint.</option>
                        <option value="Water Processing Facility">Water Processing Facility</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New User</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="create-user-form">
                <div class="form-group">
                    <label for="create-username">Username *</label>
                    <input type="text" id="create-username" name="create-username" required>
                </div>
                <div class="form-group">
                    <label for="create-password">Password *</label>
                    <input type="password" id="create-password" name="create-password" required>
                </div>
                <div class="form-group">
                    <label for="create-fullname">Full Name *</label>
                    <input type="text" id="create-fullname" name="create-fullname" required>
                </div>
                <div class="form-group">
                    <label for="create-user-level">User Level *</label>
                    <select id="create-user-level" name="create-user-level" required>
                        <option value="">Select User Level</option>
                        <option value="Manager">Manager</option>
                        <option value="Assistant Manager">Assistant Manager</option>
                        <option value="Secretary">Secretary</option>
                        <option value="Section Manager">Section Manager</option>
                        <option value="Guest">Guest</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

  <script>
    // DOM Elements - keep your existing ones
    const loginSection = document.getElementById('login-section');
    const userDashboard = document.getElementById('user-dashboard');
    const adminDashboard = document.getElementById('admin-dashboard');
    const loginForm = document.getElementById('login-form');
    const adminLoginForm = document.getElementById('admin-login-form');
    const personnelForm = document.getElementById('personnel-form');
    const createUserForm = document.getElementById('create-user-form');
    const adminLoginModal = document.getElementById('admin-login-modal');
    const personnelModal = document.getElementById('personnel-modal');
    const createUserModal = document.getElementById('create-user-modal');
    const adminIcon = document.getElementById('admin-icon');
    const addPersonnelBtn = document.getElementById('add-personnel-btn');
    const createUserBtn = document.getElementById('create-user-btn');
    const accessAdminBtn = document.getElementById('access-admin-btn');
    const backToUserBtn = document.getElementById('back-to-user-btn');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    const loginError = document.getElementById('login-error');
    const adminLoginError = document.getElementById('admin-login-error');
    const personnelTableBody = document.getElementById('personnel-table-body');
    const adminPersonnelTableBody = document.getElementById('admin-personnel-table-body');
    const userManagementTableBody = document.getElementById('user-management-table-body');
    const userNameSpan = document.getElementById('user-name');
    const userLevelDisplay = document.getElementById('user-level-display');
    const userDashboardTitle = document.getElementById('user-dashboard-title');
    const currentDateTimeElement = document.getElementById('current-datetime');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Current user state
    let currentUser = null;
    let isAdmin = false;
    let editingPersonnelId = null;
    let fromUserPage = false;

    // Test storage on load
    console.log('Storage test:', dataManager.testStorage() ? 'PASSED' : 'FAILED');
    console.log('Current personnel count:', dataManager.getPersonnel().length);
    console.log('Current users count:', dataManager.getUsers().length);

    // Initialize datetime
    function updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        if (currentDateTimeElement) {
            currentDateTimeElement.textContent = now.toLocaleDateString('en-US', options);
        }
    }

    // Update datetime every second
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Event Listeners - keep your existing ones
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing event listeners');
        
        // FORM SUBMISSIONS
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
        }
        
        if (adminLoginForm) {
            adminLoginForm.addEventListener('submit', handleAdminLogin);
        }
        
        if (personnelForm) {
            personnelForm.addEventListener('submit', handlePersonnelSubmit);
        }
        
        if (createUserForm) {
            createUserForm.addEventListener('submit', handleCreateUserSubmit);
        }
        
        // BUTTON CLICKS
        if (adminIcon) {
            adminIcon.addEventListener('click', showAdminLoginModal);
        }
        
        if (addPersonnelBtn) {
            addPersonnelBtn.addEventListener('click', showAddPersonnelModal);
        }
        
        if (createUserBtn) {
            createUserBtn.addEventListener('click', showCreateUserModal);
        }
        
        if (accessAdminBtn) {
            accessAdminBtn.addEventListener('click', accessAdminDashboard);
        }
        
        if (backToUserBtn) {
            backToUserBtn.addEventListener('click', backToUserPage);
        }

        // TAB FUNCTIONALITY
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to current button and content
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Render appropriate tables when tabs are clicked
                if (tabId === 'user-management') {
                    renderUserManagementTable();
                } else if (tabId === 'personnel-management') {
                    renderAdminPersonnelTable();
                }
            });
        });

        // MODAL CLOSE BUTTONS
        closeModalButtons.forEach(button => {
            button.addEventListener('click', closeAllModals);
        });

        // CLOSE MODAL WHEN CLICKING OUTSIDE
        window.addEventListener('click', (e) => {
            if (e.target === adminLoginModal) {
                closeAllModals();
            }
            if (e.target === personnelModal) {
                closeAllModals();
            }
            if (e.target === createUserModal) {
                closeAllModals();
            }
        });

        // NAVIGATION LINKS
        const logoutUser = document.getElementById('logout-link-user');
        const logoutAdmin = document.getElementById('logout-link-admin');
        
        if (logoutUser) {
            logoutUser.addEventListener('click', handleLogout);
        }
        
        if (logoutAdmin) {
            logoutAdmin.addEventListener('click', handleLogout);
        }

        // INITIALIZE DATA DISPLAY
        renderPersonnelTable();
        renderAdminPersonnelTable();
        renderUserManagementTable();
    });

    // Login function - UPDATED to use dataManager
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Check if user exists using dataManager
        const user = dataManager.getUsers().find(acc => 
            acc.username === username && acc.password === password && acc.status === 'approved'
        );
        
        if (user) {
            currentUser = user;
            isAdmin = user.userLevel === 'Administrator';
            
            if (loginError) loginError.style.display = 'none';
            
            // Update last login
            user.lastLogin = new Date().toISOString().split('T')[0];
            dataManager.updateUser(user);
            
            if (isAdmin) {
                showAdminDashboard();
            } else {
                redirectToUserPage();
            }
        } else {
            if (loginError) {
                loginError.style.display = 'block';
                loginError.textContent = 'Invalid username or password. Please try again.';
            }
        }
    }

    // Admin login function - UPDATED
    function handleAdminLogin(e) {
        e.preventDefault();
        const adminUsername = document.getElementById('admin-username').value;
        const adminPassword = document.getElementById('admin-password').value;
        
        // Check if admin exists using dataManager
        const adminUser = dataManager.getUsers().find(acc => 
            acc.username === adminUsername && acc.password === adminPassword && 
            acc.status === 'approved' && acc.userLevel === 'Administrator'
        );
        
        if (adminUser) {
            isAdmin = true;
            currentUser = adminUser;
            
            if (adminLoginError) adminLoginError.style.display = 'none';
            closeAllModals();
            showAdminDashboard();
        } else {
            if (adminLoginError) {
                adminLoginError.style.display = 'block';
                adminLoginError.textContent = 'Invalid administrator credentials. Please try again.';
            }
        }
    }

    // Create user function - UPDATED
    function handleCreateUserSubmit(e) {
        e.preventDefault();
        
        const username = document.getElementById('create-username').value;
        const password = document.getElementById('create-password').value;
        const fullName = document.getElementById('create-fullname').value;
        const userLevel = document.getElementById('create-user-level').value;
        
        // Validate required fields
        if (!username || !password || !fullName || !userLevel) {
            alert('Please fill in all required fields.');
            return;
        }
        
        // Check if username already exists using dataManager
        const usernameExists = dataManager.getUsers().some(acc => acc.username === username);
        
        if (usernameExists) {
            alert('Username already exists. Please choose a different username.');
            return;
        }
        
        // Create user
        const newUser = {
            username: username,
            password: password,
            fullName: fullName,
            status: 'approved',
            userLevel: userLevel
        };
        
        // Add to user accounts using dataManager
        if (dataManager.addUser(newUser)) {
            // Update UI
            renderUserManagementTable();
            
            // Show success message
            alert(`âœ… SUCCESS! User "${username}" has been created with "${userLevel}" access level.`);
            
            // Close modal and reset form
            closeAllModals();
            createUserForm.reset();
        } else {
            alert('Error creating user. Please try again.');
        }
    }

    // Personnel submit function - UPDATED
    function handlePersonnelSubmit(e) {
        e.preventDefault();
        
        const personnel = {
            familyName: document.getElementById('family-name').value,
            firstName: document.getElementById('first-name').value,
            middleName: document.getElementById('middle-name').value,
            idNumber: document.getElementById('id-number').value,
            dateHired: document.getElementById('date-hired').value,
            employmentStatus: document.getElementById('employment-status').value,
            currentPosition: document.getElementById('current-position').value,
            workStatus: document.getElementById('work-status').value,
            sectionAssignment: document.getElementById('section-assignment').value
        };
        
        // Validate required fields
        if (!personnel.familyName || !personnel.firstName || !personnel.idNumber || !personnel.dateHired || 
            !personnel.employmentStatus || !personnel.currentPosition || !personnel.workStatus || !personnel.sectionAssignment) {
            alert('Please fill in all required fields.');
            return;
        }
        
        let success = false;
        
        if (editingPersonnelId) {
            // Update existing personnel
            personnel.id = editingPersonnelId;
            success = dataManager.updatePersonnel(personnel);
            if (success) {
                alert('Personnel record updated successfully!');
            }
        } else {
            // Add new personnel
            success = dataManager.addPersonnel(personnel);
            if (success) {
                alert('Personnel record added successfully!');
            }
        }
        
        if (success) {
            closeAllModals();
            resetPersonnelForm();
            renderPersonnelTable();
            renderAdminPersonnelTable();
        } else {
            alert('Error saving personnel record. Please try again.');
        }
    }

    // Keep all your existing functions like:
    // handleLogout, showLoginSection, showAdminLoginModal, etc.
    // (They don't need changes)

    function handleLogout(e) {
        e.preventDefault();
        currentUser = null;
        isAdmin = false;
        fromUserPage = false;
        showLoginSection();
        if (userDashboard) userDashboard.style.display = 'none';
        if (adminDashboard) adminDashboard.style.display = 'none';
        if (loginForm) loginForm.reset();
    }

    function showLoginSection() {
        if (loginSection) loginSection.style.display = 'flex';
        if (userDashboard) userDashboard.style.display = 'none';
        if (adminDashboard) adminDashboard.style.display = 'none';
        
        if (loginError) loginError.style.display = 'none';
    }

    function showAdminLoginModal() {
        if (adminLoginModal) {
            adminLoginModal.style.display = 'flex';
            if (adminLoginForm) adminLoginForm.reset();
            if (adminLoginError) adminLoginError.style.display = 'none';
        }
    }

    function showAddPersonnelModal() {
        if (personnelModal) {
            document.getElementById('personnel-modal-title').textContent = 'Add Personnel';
            editingPersonnelId = null;
            personnelModal.style.display = 'flex';
            if (personnelForm) personnelForm.reset();
        }
    }

    function showCreateUserModal() {
        if (createUserModal) {
            createUserModal.style.display = 'flex';
            if (createUserForm) createUserForm.reset();
        }
    }

    function closeAllModals() {
        if (adminLoginModal) adminLoginModal.style.display = 'none';
        if (personnelModal) personnelModal.style.display = 'none';
        if (createUserModal) createUserModal.style.display = 'none';
        resetPersonnelForm();
    }

    function resetPersonnelForm() {
        if (personnelForm) personnelForm.reset();
        editingPersonnelId = null;
    }

    function showUserDashboard() {
        if (loginSection) loginSection.style.display = 'none';
        if (userDashboard) userDashboard.style.display = 'block';
        if (adminDashboard) adminDashboard.style.display = 'none';
        
        if (userNameSpan && currentUser) userNameSpan.textContent = currentUser.fullName;
        if (userLevelDisplay && currentUser) userLevelDisplay.textContent = currentUser.userLevel;
        
        // Show admin access button for admin users
        if (accessAdminBtn && currentUser && currentUser.userLevel === 'Administrator') {
            accessAdminBtn.style.display = 'inline-block';
        } else if (accessAdminBtn) {
            accessAdminBtn.style.display = 'none';
        }
        
        // Update dashboard title based on user level
        if (userDashboardTitle && currentUser) {
            switch(currentUser.userLevel) {
                case 'Manager':
                    userDashboardTitle.textContent = 'Manager Dashboard';
                    break;
                case 'Assistant Manager':
                    userDashboardTitle.textContent = 'Assistant Manager Dashboard';
                    break;
                case 'Secretary':
                    userDashboardTitle.textContent = 'Secretary Dashboard';
                    break;
                case 'Section Manager':
                    userDashboardTitle.textContent = 'Section Manager Dashboard';
                    break;
                case 'Guest':
                    userDashboardTitle.textContent = 'Guest Dashboard';
                    break;
                default:
                    userDashboardTitle.textContent = 'User Dashboard';
            }
        }
        
        renderPersonnelTable();
    }

    function redirectToUserPage() {
        if (!currentUser) return;
        
        switch(currentUser.userLevel) {
            case 'Manager':
                window.location.href = 'manager-page.html';
                break;
            case 'Assistant Manager':
                window.location.href = 'assistant-manager-page.html';
                break;
            case 'Secretary':
                window.location.href = 'office-secretary-page.html';
                break;
            case 'Section Manager':
                window.location.href = 'section-supervisor-page.html';
                break;
            case 'Guest':
                window.location.href = 'guest-page.html';
                break;
            default:
                showUserDashboard();
        }
    }

    function showAdminDashboard() {
        if (loginSection) loginSection.style.display = 'none';
        if (userDashboard) userDashboard.style.display = 'none';
        if (adminDashboard) adminDashboard.style.display = 'block';
        
        // Show back to user button if coming from user page
        if (backToUserBtn) {
            if (fromUserPage) {
                backToUserBtn.style.display = 'inline-block';
            } else {
                backToUserBtn.style.display = 'none';
            }
        }
        
        // Render all admin tables
        renderAdminPersonnelTable();
        renderUserManagementTable();
    }

    function accessAdminDashboard() {
        fromUserPage = true;
        showAdminDashboard();
    }

    function backToUserPage() {
        fromUserPage = false;
        showUserDashboard();
    }

    // DELETE functions - UPDATED to use dataManager
    function deletePersonnel(id) {
        if (confirm('Are you sure you want to delete this personnel record?')) {
            if (dataManager.deletePersonnel(id)) {
                renderAdminPersonnelTable();
                renderPersonnelTable();
                alert('Personnel record deleted successfully!');
            } else {
                alert('Error deleting personnel record.');
            }
        }
    }

    function deleteUser(id) {
        if (id === 999) {
            alert('Cannot delete the system administrator account.');
            return;
        }
        
        if (confirm('Are you sure you want to delete this user account?')) {
            if (dataManager.deleteUser(id)) {
                renderUserManagementTable();
                alert('User account deleted successfully!');
            } else {
                alert('Error deleting user account.');
            }
        }
    }

    // RENDER functions - UPDATED to use dataManager
    function renderPersonnelTable() {
        if (!personnelTableBody) return;
        
        const personnel = dataManager.getPersonnel();
        const sortedPersonnel = [...personnel].sort((a, b) => 
            a.familyName.localeCompare(b.familyName)
        );
        
        personnelTableBody.innerHTML = '';
        
        if (sortedPersonnel.length === 0) {
            personnelTableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center;">No personnel records found</td>
                </tr>
            `;
            return;
        }
        
        sortedPersonnel.forEach(personnel => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${personnel.familyName}, ${personnel.firstName} ${personnel.middleName || ''}</td>
                <td>${personnel.idNumber}</td>
                <td>${formatDate(personnel.dateHired)}</td>
                <td>${personnel.employmentStatus}</td>
                <td>${personnel.currentPosition}</td>
                <td>${personnel.workStatus}</td>
                <td>${personnel.sectionAssignment}</td>
            `;
            personnelTableBody.appendChild(row);
        });
    }

    function renderAdminPersonnelTable() {
        if (!adminPersonnelTableBody) return;
        
        const personnel = dataManager.getPersonnel();
        const sortedPersonnel = [...personnel].sort((a, b) => 
            a.familyName.localeCompare(b.familyName)
        );
        
        adminPersonnelTableBody.innerHTML = '';
        
        if (sortedPersonnel.length === 0) {
            adminPersonnelTableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center;">No personnel records found</td>
                </tr>
            `;
            return;
        }
        
        sortedPersonnel.forEach(personnel => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${personnel.familyName}, ${personnel.firstName} ${personnel.middleName || ''}</td>
                <td>${personnel.idNumber}</td>
                <td>${formatDate(personnel.dateHired)}</td>
                <td>${personnel.employmentStatus}</td>
                <td>${personnel.currentPosition}</td>
                <td>${personnel.workStatus}</td>
                <td>${personnel.sectionAssignment}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="showEditPersonnelModal(${personnel.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deletePersonnel(${personnel.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            adminPersonnelTableBody.appendChild(row);
        });
    }

    function renderUserManagementTable() {
        if (!userManagementTableBody) return;
        
        const users = dataManager.getUsers();
        
        userManagementTableBody.innerHTML = '';
        
        if (users.length === 0) {
            userManagementTableBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center;">No user accounts found</td>
                </tr>
            `;
            return;
        }
        
        users.forEach(user => {
            const statusBadge = user.status === 'approved' ? 
                '<span class="status-badge status-active">Active</span>' : 
                '<span class="status-badge status-revoked">Revoked</span>';
            
            const userLevelBadge = getUserLevelBadge(user.userLevel);
            const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : 'Never';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.fullName}</td>
                <td><span class="password-field">${user.password}</span></td>
                <td>${userLevelBadge}</td>
                <td>${statusBadge}</td>
                <td>${lastLogin}</td>
                <td>
                    <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            userManagementTableBody.appendChild(row);
        });
    }

    function getUserLevelBadge(userLevel) {
        if (!userLevel) return '-';
        
        const levelClass = userLevel.toLowerCase().replace(' ', '-');
        return `<span class="user-level-badge level-${levelClass}">${userLevel}</span>`;
    }

    function showEditPersonnelModal(id) {
        const personnel = dataManager.getPersonnel().find(p => p.id === id);
        if (personnel) {
            document.getElementById('personnel-modal-title').textContent = 'Edit Personnel';
            editingPersonnelId = id;
            
            document.getElementById('family-name').value = personnel.familyName;
            document.getElementById('first-name').value = personnel.firstName;
            document.getElementById('middle-name').value = personnel.middleName || '';
            document.getElementById('id-number').value = personnel.idNumber;
            document.getElementById('date-hired').value = personnel.dateHired;
            document.getElementById('employment-status').value = personnel.employmentStatus;
            document.getElementById('current-position').value = personnel.currentPosition;
            document.getElementById('work-status').value = personnel.workStatus;
            document.getElementById('section-assignment').value = personnel.sectionAssignment;
            
            if (personnelModal) personnelModal.style.display = 'flex';
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // NEW DATA MANAGEMENT FUNCTIONS FOR THE BUTTONS
    window.exportData = function() {
        const dataStr = dataManager.exportData();
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `fomd_data_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('Data exported successfully!');
    };

    window.importData = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (confirm('This will replace all current data. Are you sure?')) {
                        if (dataManager.importData(e.target.result)) {
                            renderPersonnelTable();
                            renderAdminPersonnelTable();
                            renderUserManagementTable();
                            alert('Data imported successfully!');
                        } else {
                            alert('Error importing data. Please check the file format.');
                        }
                    }
                };
                reader.readAsText(file);
            }
        };
        
        input.click();
    };

    window.clearAllData = function() {
        if (confirm('WARNING: This will permanently delete all personnel and user data (except admin). This action cannot be undone. Are you sure?')) {
            if (confirm('Are you absolutely sure? All data will be lost.')) {
                dataManager.clearAllData();
                renderPersonnelTable();
                renderAdminPersonnelTable();
                renderUserManagementTable();
                alert('All data has been cleared. Only the admin account remains.');
            }
        }
    };

    // Make functions globally available
    window.showEditPersonnelModal = showEditPersonnelModal;
    window.deletePersonnel = deletePersonnel;
    window.deleteUser = deleteUser;
</script>
</body>
</html>